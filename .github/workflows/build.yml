name: Desktop CI Build

on:
  # Uncomment the following lines to enable automatic running on push/PR
  # push:
  #   branches: [main]
  # pull_request:
  #   branches: [main]
    
  workflow_dispatch:
    inputs:
      os_to_build:
        description: 'Select OS(es) to build'
        required: true
        type: choice
        # The options must be valid JSON arrays (as strings)
        options:
          - '["linux", "windows", "macos"]'
          - '["windows"]'
          - '["macos"]'
          - '["linux"]'

jobs:
  build_linux:
    name: Build Linux
    runs-on: ubuntu-latest
    if: contains(fromJSON(github.event.inputs.os_to_build), 'linux')
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Flutter Environment
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          
      - name: Get Dependencies
        run: flutter pub get
        
      - name: Install Linux Build Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev libsecret-1-dev 
          
      - name: Build Release Artifact
        run: flutter build linux --release --dart-define=SUPABASE_URL="$SUPABASE_URL" --dart-define=SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY"

      - name: Package Artifact
        run: |
          mkdir -p dist/gitscribe-linux
          cp -r build/linux/x64/release/bundle/* dist/gitscribe-linux/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: dist/gitscribe-linux

  build_windows:
    name: Build Windows
    runs-on: windows-latest
    if: contains(fromJSON(github.event.inputs.os_to_build), 'windows')
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Flutter Environment
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          
      - name: Get Dependencies
        run: flutter pub get
          
      - name: Build Release Artifact
        run: flutter build windows --release --dart-define=SUPABASE_URL="$SUPABASE_URL" --dart-define=SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY"

      - name: Package Artifact
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist/gitscribe-windows
          Copy-Item -Path build/windows/x64/runner/Release/* -Destination dist/gitscribe-windows -Recurse -Force

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: dist/gitscribe-windows

  build_macos:
    name: Build macOS
    runs-on: macos-latest
    if: contains(fromJSON(github.event.inputs.os_to_build), 'macos')
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Flutter Environment
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          
      - name: Get Dependencies
        run: flutter pub get
          
      - name: Build Release Artifact
        run: flutter build macos --release --dart-define=SUPABASE_URL="$SUPABASE_URL" --dart-define=SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY"

      - name: Package Artifact
        run: |
          mkdir -p dist/gitscribe-macos
          cp -r build/macos/Build/Products/Release/*.app dist/gitscribe-macos/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: dist/gitscribe-macos