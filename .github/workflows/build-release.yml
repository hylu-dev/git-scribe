name: Multi-Platform Release Build

on:
  # Uncomment to run automatically on push/PR
  # push:
  #   branches: [main]
  # pull_request:
  #   branches: [main]

  workflow_dispatch:
    inputs:
      os_to_build:
        description: 'Select OS(es) to build'
        required: true
        type: choice
        options:
          - '["linux", "windows", "macos", "android"]'
          - '["android"]'
          - '["linux", "windows", "macos"]'
          - '["linux", "windows"]'
          - '["linux", "macos"]'
          - '["windows", "macos"]'
          - '["linux"]'
          - '["windows"]'
          - '["macos"]'
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string
      release_notes:
        description: 'Additional release notes (optional, auto-generated notes will be used)'
        required: false
        type: string
        default: ''

jobs:
  # ──────────────────────────────
  # Create Release and Tag
  # ──────────────────────────────
  create_release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Tag
        run: |
          TAG="${{ github.event.inputs.tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, deleting it"
            git tag -d "$TAG" || true
            git push origin ":refs/tags/$TAG" || true
          fi
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: Release ${{ github.event.inputs.tag }}
          generate_release_notes: true
          body: |
            ${{ github.event.inputs.release_notes }}
            
            ## Artifacts
            
            This release includes builds for the selected platforms.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ──────────────────────────────
  # Linux Desktop
  # ──────────────────────────────
  build_linux:
    needs: create_release
    name: Build Linux
    runs-on: ubuntu-latest
    if: contains(fromJSON(github.event.inputs.os_to_build), 'linux')
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Flutter Environment
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get Dependencies
        run: flutter pub get

      - name: Install Linux Build Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev libsecret-1-dev

      - name: Build Release Artifact
        run: >
          flutter build linux --release
          --dart-define=SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          --dart-define=SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"

      - name: Package Artifact
        run: |
          mkdir -p dist/gitscribe-linux
          cp -r build/linux/x64/release/bundle/* dist/gitscribe-linux/
          cd dist/gitscribe-linux
          tar -czf ../gitscribe-linux.tar.gz .

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/gitscribe-linux.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ──────────────────────────────
  # Windows Desktop
  # ──────────────────────────────
  build_windows:
    name: Build Windows
    runs-on: windows-latest
    needs: create_release
    if: contains(fromJSON(github.event.inputs.os_to_build), 'windows')
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Flutter Environment
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get Dependencies
        run: flutter pub get

      - name: Build Release Artifact
        run: >
          flutter build windows --release
          --dart-define=SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          --dart-define=SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"

      - name: Package Artifact
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist/gitscribe-windows
          Copy-Item -Path build/windows/x64/runner/Release/* -Destination dist/gitscribe-windows -Recurse -Force
          Compress-Archive -Path dist/gitscribe-windows/* -DestinationPath dist/gitscribe-windows.zip -Force

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/gitscribe-windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ──────────────────────────────
  # macOS Desktop
  # ──────────────────────────────
  build_macos:
    name: Build macOS
    runs-on: macos-latest
    needs: create_release
    if: contains(fromJSON(github.event.inputs.os_to_build), 'macos')
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Flutter Environment
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get Dependencies
        run: flutter pub get

      - name: Build Release Artifact
        run: >
          flutter build macos --release
          --dart-define=SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          --dart-define=SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"

      - name: Package Artifact
        run: |
          mkdir -p dist/gitscribe-macos
          cp -r build/macos/Build/Products/Release/*.app dist/gitscribe-macos/
          cd dist/gitscribe-macos
          zip -r ../gitscribe-macos.zip *.app

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/gitscribe-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ──────────────────────────────
  # Android (APK + AppBundle)
  # ──────────────────────────────
  build_android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: create_release
    if: contains(fromJSON(github.event.inputs.os_to_build), 'android')
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get Dependencies
        run: flutter pub get

      # Optional: run tests
      # - name: Run Flutter tests
      #   run: flutter test

      - name: Build APK (universal)
        run: >
          flutter build apk --release
          --dart-define=SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          --dart-define=SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"

      - name: Build AppBundle (Google Play)
        run: >
          flutter build appbundle --release
          --dart-define=SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          --dart-define=SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"

      - name: Prepare Android artifacts
        run: |
          mkdir -p dist/android
          cp build/app/outputs/flutter-apk/app-release.apk dist/android/gitscribe-android.apk
          cp build/app/outputs/bundle/release/app-release.aab dist/android/gitscribe-android.aab

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/android/gitscribe-android.apk
            dist/android/gitscribe-android.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
